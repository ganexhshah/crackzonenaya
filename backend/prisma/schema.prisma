generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  password      String?
  fullName      String?
  avatar        String?
  gameName      String?
  gameId        String?
  role          Role      @default(USER)
  status        UserStatus @default(ACTIVE)
  isVerified    Boolean   @default(false)
  verificationToken String?
  resetToken    String?
  resetTokenExpiry DateTime?
  balance       Float     @default(0)
  googleId      String?   @unique
  provider      AuthProvider @default(LOCAL)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  profile       Profile?
  teams         TeamMember[]
  ownedTeams    Team[]    @relation("TeamOwner")
  matches       MatchPlayer[]
  tournaments   TournamentRegistration[]
  transactions  Transaction[]
  notifications Notification[]
  joinRequests  TeamJoinRequest[] @relation("UserJoinRequests")
  supportTickets SupportTicket[]
  assignedTickets SupportTicket[] @relation("AssignedTickets")
  ticketMessages TicketMessage[]
  reportsMade   Report[]  @relation("ReportsMade")
  reportsReceived Report[] @relation("ReportsReceived")
  reportsReviewed Report[] @relation("ReportsReviewed")
  contactMessages ContactMessage[]
  
  friendsInitiated Friend[] @relation("FriendsInitiated")
  friendsReceived  Friend[] @relation("FriendsReceived")
  messagesSent     Message[] @relation("MessagesSent")
  messagesReceived Message[] @relation("MessagesReceived")

  customRoomsCreated CustomRoom[] @relation("CustomRoomCreator")
  customRoomsJoined  CustomRoom[] @relation("CustomRoomOpponent")
  customRoomReports  CustomRoomReport[]
  
  @@index([email])
  @@index([username])
  @@index([gameId])
  @@index([googleId])
}

enum AuthProvider {
  LOCAL
  GOOGLE
  FACEBOOK
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

model Profile {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameId        String?
  gameUsername  String?
  rank          String?
  bio           String?
  phone         String?
  country       String?
  discordId     String?
  instagramHandle String?
  stats         Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Team {
  id            String    @id @default(cuid())
  name          String
  tag           String    @unique
  logo          String?
  description   String?
  ownerId       String
  owner         User      @relation("TeamOwner", fields: [ownerId], references: [id])
  isActive      Boolean   @default(true)
  balance       Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  members       TeamMember[]
  matches       Match[]
  tournaments   TournamentRegistration[]
  transactions  TeamTransaction[]
  moneyRequests TeamMoneyRequest[]
  joinRequests  TeamJoinRequest[] @relation("TeamJoinRequests")
  invitations   TeamInvitation[] @relation("TeamInvitations")
  
  @@index([ownerId])
  @@index([tag])
}

model TeamTransaction {
  id            String    @id @default(cuid())
  teamId        String
  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId        String?
  type          TeamTransactionType
  amount        Float
  description   String?
  reference     String?
  createdAt     DateTime  @default(now())
  
  @@index([teamId])
  @@index([userId])
}

enum TeamTransactionType {
  DEPOSIT
  WITHDRAWAL
  ENTRY_FEE
  PRIZE_WINNING
  MEMBER_CONTRIBUTION
  REFUND
}

model TeamMoneyRequest {
  id            String    @id @default(cuid())
  teamId        String
  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  requestedBy   String
  requestedFrom String
  amount        Float
  reason        String?
  status        MoneyRequestStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  respondedAt   DateTime?
  
  @@index([teamId])
  @@index([requestedFrom])
  @@index([status])
}

enum MoneyRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model TeamMember {
  id            String    @id @default(cuid())
  teamId        String
  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role          TeamRole  @default(MEMBER)
  joinedAt      DateTime  @default(now())
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamJoinRequest {
  id            String    @id @default(cuid())
  teamId        String
  team          Team      @relation("TeamJoinRequests", fields: [teamId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation("UserJoinRequests", fields: [userId], references: [id], onDelete: Cascade)
  status        JoinRequestStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model TeamInvitation {
  id            String    @id @default(cuid())
  teamId        String
  team          Team      @relation("TeamInvitations", fields: [teamId], references: [id], onDelete: Cascade)
  userId        String
  invitedBy     String
  status        InvitationStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum TeamRole {
  OWNER
  CAPTAIN
  MEMBER
}

model Match {
  id            String    @id @default(cuid())
  title         String
  description   String?
  teamId        String?
  team          Team?     @relation(fields: [teamId], references: [id])
  opponentName  String
  matchType     MatchType
  status        MatchStatus @default(SCHEDULED)
  scheduledAt   DateTime
  startedAt     DateTime?
  endedAt       DateTime?
  result        String?
  score         String?
  roomId        String?
  roomPassword  String?
  scrimConfig   Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  players       MatchPlayer[]
  
  @@index([teamId])
  @@index([status])
}

enum MatchType {
  SCRIM
  TOURNAMENT
  PRACTICE
}

enum MatchStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

model MatchPlayer {
  id            String    @id @default(cuid())
  matchId       String
  match         Match     @relation(fields: [matchId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  kills         Int       @default(0)
  deaths        Int       @default(0)
  assists       Int       @default(0)
  damage        Int       @default(0)
  
  @@unique([matchId, userId])
  @@index([matchId])
  @@index([userId])
}

model Tournament {
  id            String    @id @default(cuid())
  name          String
  description   String?
  banner        String?
  prizePool     Float?
  entryFee      Float     @default(0)
  maxTeams      Int
  format        String
  rules         String?
  status        TournamentStatus @default(UPCOMING)
  registrationStart DateTime
  registrationEnd   DateTime
  startDate     DateTime
  endDate       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  registrations TournamentRegistration[]
  
  @@index([status])
}

enum TournamentStatus {
  UPCOMING
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  ONGOING
  COMPLETED
  CANCELLED
}

model TournamentRegistration {
  id            String    @id @default(cuid())
  tournamentId  String
  tournament    Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  teamId        String
  team          Team      @relation(fields: [teamId], references: [id])
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  status        RegistrationStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  registeredAt  DateTime  @default(now())
  
  @@unique([tournamentId, teamId])
  @@index([tournamentId])
  @@index([teamId])
  @@index([userId])
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Transaction {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  type          TransactionType
  amount        Float
  status        PaymentStatus @default(PENDING)
  description   String?
  reference     String?
  receiptUrl    String?
  createdAt     DateTime  @default(now())
  
  reports       TransactionReport[]
  
  @@index([userId])
  @@index([status])
  @@unique([type, reference])
}

model TransactionReport {
  id            String    @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  userId        String
  issueType     String
  description   String
  status        ReportIssueStatus @default(PENDING)
  adminRemark   String?
  resolvedBy    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  resolvedAt    DateTime?
  
  @@index([transactionId])
  @@index([userId])
  @@index([status])
}

enum ReportIssueStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  REJECTED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TOURNAMENT_FEE
  PRIZE_WINNING
  REFUND
  CUSTOM_MATCH_STAKE
  CUSTOM_MATCH_PAYOUT
}

// Custom Match Rooms (wager/custom rooms)

enum CustomRoomType {
  CUSTOM_ROOM
  LONE_WOLF
}

enum CustomRoomStatus {
  OPEN
  WAITING_JOIN
  READY_TO_START
  STARTED
  RESULT_SUBMITTED
  UNDER_REVIEW
  RESOLVED
  REJECTED
  CANCELLED
}

enum CustomRoomTeamSize {
  ONE_V_ONE
  TWO_V_TWO
  THREE_V_THREE
  FOUR_V_FOUR
}

enum CustomRoomWinnerSide {
  CREATOR
  OPPONENT
}

model CustomRoom {
  id              String           @id @default(cuid())
  type            CustomRoomType
  status          CustomRoomStatus @default(OPEN)

  creatorId       String
  creator         User             @relation("CustomRoomCreator", fields: [creatorId], references: [id])
  opponentId      String?
  opponent        User?            @relation("CustomRoomOpponent", fields: [opponentId], references: [id])

  teamSize        CustomRoomTeamSize
  rounds          Int

  throwableLimit  Boolean          @default(false)
  characterSkill  Boolean          @default(false)
  headshotOnly    Boolean          @default(false)
  gunAttributes   Boolean          @default(false)

  coinSetting     Int              @default(0) // 0 means default, otherwise e.g. 9950
  roomMaker       String           @default("ME") // ME / OPPONENT

  entryFee        Float            @default(0)
  odds            Float            @default(1.8)
  payout          Float            @default(0) // computed at create/join time

  creatorReady    Boolean          @default(false)
  opponentReady   Boolean          @default(false)

  roomId          String?
  roomPassword    String?

  resultScreenshotUrl String?
  winnerSide      CustomRoomWinnerSide?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  resolvedAt      DateTime?

  reports         CustomRoomReport[]

  @@index([creatorId])
  @@index([opponentId])
  @@index([status])
  @@index([type])
}

model CustomRoomReport {
  id          String   @id @default(cuid())
  roomId      String
  room        CustomRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  reporterId  String
  reporter    User     @relation(fields: [reporterId], references: [id])
  reason      String
  description String
  evidence    String[]
  createdAt   DateTime @default(now())

  @@index([roomId])
  @@index([reporterId])
}

model Notification {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title         String
  message       String
  type          NotificationType
  isRead        Boolean   @default(false)
  link          String?
  createdAt     DateTime  @default(now())
  
  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  MATCH
  TOURNAMENT
  TEAM
  PAYMENT
  WALLET
  SCRIM
  TEAM_INVITE
  TEAM_JOIN
  MATCH_RESULT
  TOURNAMENT_START
  TRANSACTION
  SYSTEM
  ANNOUNCEMENT
}

model PaymentMethod {
  id            String    @id @default(cuid())
  name          String
  type          PaymentMethodType
  accountNumber String?
  accountName   String?
  upiId         String?
  qrCodeUrl     String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([isActive])
}

enum PaymentMethodType {
  UPI
  BANK
  WALLET
}

// Support & Help Center Models

model FAQ {
  id            String    @id @default(cuid())
  category      FAQCategory
  question      String
  answer        String
  order         Int       @default(0)
  isActive      Boolean   @default(true)
  views         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([category])
  @@index([isActive])
}

enum FAQCategory {
  ACCOUNT
  PAYMENT
  TOURNAMENT
  MATCH_RULES
  PRIZES
  REFUND
  CHEATING
  TECHNICAL
  OTHER
}

model SupportTicket {
  id            String    @id @default(cuid())
  ticketNumber  String    @unique
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  category      TicketCategory
  priority      TicketPriority @default(MEDIUM)
  subject       String
  description   String
  status        TicketStatus @default(OPEN)
  assignedToId  String?
  assignedTo    User?     @relation("AssignedTickets", fields: [assignedToId], references: [id])
  attachments   String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  resolvedAt    DateTime?
  
  messages      TicketMessage[]
  
  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([assignedToId])
}

enum TicketCategory {
  PAYMENT
  MATCH_ISSUE
  BAN_APPEAL
  TECHNICAL
  ACCOUNT
  REFUND
  REPORT
  OTHER
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_USER
  RESOLVED
  CLOSED
}

model TicketMessage {
  id            String    @id @default(cuid())
  ticketId      String
  ticket        SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  message       String
  attachments   String[]
  isStaffReply  Boolean   @default(false)
  createdAt     DateTime  @default(now())
  
  @@index([ticketId])
  @@index([userId])
}

model Report {
  id            String    @id @default(cuid())
  reporterId    String
  reporter      User      @relation("ReportsMade", fields: [reporterId], references: [id])
  reportedUserId String?
  reportedUser  User?     @relation("ReportsReceived", fields: [reportedUserId], references: [id])
  type          ReportType
  reason        String
  description   String
  matchId       String?
  evidence      String[]
  status        ReportStatus @default(PENDING)
  reviewedById  String?
  reviewedBy    User?     @relation("ReportsReviewed", fields: [reviewedById], references: [id])
  reviewNotes   String?
  reviewedAt    DateTime?
  createdAt     DateTime  @default(now())
  
  @@index([reporterId])
  @@index([reportedUserId])
  @@index([status])
  @@index([type])
}

enum ReportType {
  CHEATING
  FAKE_PAYMENT
  ABUSE
  PLAYER_MISCONDUCT
  MATCH_FIXING
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

model ContactMessage {
  id            String    @id @default(cuid())
  name          String
  email         String
  subject       String
  message       String
  userId        String?
  user          User?     @relation(fields: [userId], references: [id])
  status        MessageStatus @default(UNREAD)
  repliedAt     DateTime?
  createdAt     DateTime  @default(now())
  
  @@index([status])
  @@index([userId])
}

enum MessageStatus {
  UNREAD
  READ
  REPLIED
}

model Friend {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation("FriendsInitiated", fields: [userId], references: [id], onDelete: Cascade)
  friendId      String
  friend        User      @relation("FriendsReceived", fields: [friendId], references: [id], onDelete: Cascade)
  status        FriendStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
  @@index([status])
}

enum FriendStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

model Message {
  id            String    @id @default(cuid())
  senderId      String
  sender        User      @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId    String
  receiver      User      @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  content       String
  read          Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([senderId])
  @@index([receiverId])
  @@index([read])
  @@index([createdAt])
}
